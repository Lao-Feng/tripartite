<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link href="../../../plugin/bstable/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../../../plugin/bstable/css/bootstrap-table.css" rel="stylesheet" type="text/css">
    <link href="../../../css/user.css" rel="stylesheet" type="text/css">
</head>
<body style="font-family: 微软雅黑;color: #475059;min-width: 1150px;overflow: auto">
<div class="mould-main">
    <div class="mould-top">
        <p>用户管理界面主要对系统用户进行新增、查询、修改等操作。</p>
    </div>
    <div class="mould-middle">
        <div class="mould-content">
            <div class="mould-right">
                <div class="mould-search">
                    <div class="mould-items">
                        <div class="mould-item2">
                            <div class="item-text">
                                角色
                            </div>
                            <div class="item-input">
                                <select id="role">
                                    <option value="0" cls="sysUser">系统维护</option>
                                    <option value="1" cls="account">注册用户</option>
                                </select>
                            </div>
                        </div>

                        <div class="mould-item sysUser">
                            <div class="item-text">
                                用户名
                            </div>
                            <div class="item-input">
                                <input type="text" id="UserName"/>
                            </div>
                        </div>
                        <div class="mould-item sysUser">
                            <div class="item-text">
                                登录名
                            </div>
                            <div class="item-input">
                                <input type="text" id="LoginName"/>
                            </div>
                        </div>
                        <div class="mould-item sysUser">
                            <div class="item-text">
                                电话号码
                            </div>
                            <div class="item-input">
                                <input type="text" id="Tel"/>
                            </div>
                        </div>

                        <div class="mould-item account">
                            <div class="item-text">
                                用户名
                            </div>
                            <div class="item-input">
                                <input type="text" id="UserName2"/>
                            </div>
                        </div>
                        <div class="mould-item account">
                            <div class="item-text">
                                邮箱
                            </div>
                            <div class="item-input">
                                <input type="text" id="EmailAddress"/>
                            </div>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
                <div class="mould-btn">
                    <div class="btn-item btn-query sysUser account">查询</div>
                    <div class="btn-item btn-add sysUser">新增</div>
                    <div class="btn-item btn-batchDelete sysUser">删除</div>
                    <div class="btn-item btn-update sysUser">编辑</div>
                    <div class="btn-item btn-reset sysUser">重置密码</div>
                </div>
                <table id="table1" class="table_style" style="margin: 0 auto"></table>
                <table id="table2" class="table_style" style="margin: 0 auto"></table>
            </div>
        </div>
    </div>
    <div class="mould-bottom">
        <p>Copyright©2013-2018 沪IPC备11000002000001号</p>
    </div>
</div>
</body>
<script src="../../../js/jquery-2.2.0.min.js"></script>
<script src="../../../plugin/bstable/js/bootstrap.min.js"></script>
<script src="../../../plugin/bstable/js/bootstrap-table.js"></script>
<script src="../../../plugin/bstable/js/bootstrap-table-zh-CN.min.js"></script>
<script src="../../../plugin/layer_v2.1/layer/layer.js"></script>
<script type="text/javascript">
    var table1,table2;
    $(function () {
        //默认加载平台用户
        $(".mould-item").hide(); $(".sysUser").show();
        loadPTUserList();//加载平台用户列表

        //查询按钮
        $(".btn-query").on("click",function () {
            var role = $("#role").find("option:selected").val();
            if(role==0){
                $("#table1").bootstrapTable('refresh');
            }else{
                $("#table2").bootstrapTable('refresh');
            }
        });
        //新增用户
        $(".btn-add").on("click",function(){
            layer.open({
                type: 2,
                title: '新增用户',
                shade: 0.5,
                skin: 'layui-layer-rim',
                closeBtn:1,
                area: ['960px', '440px'],
                content: '/page/sys/user-add.shtm'
            });
        });
        //修改用户
        $(".btn-update").on("click",function () {
            var selections = $("#table1").bootstrapTable('getSelections');
            if(selections.length == 0 || selections.length > 1){
                layer.msg("请选择一条数据进行操作");
                return;
            }else{
                var userId = selections[0].userId;
                layer.open({
                    type: 2,
                    title: '用户修改',
                    shade: 0.5,
                    skin: 'layui-layer-rim',
                    closeBtn:1,
                    area: ['960px', '440px'],
                    content: '/page/sys/user-update.shtm?userId='+userId
                });
            }
        });
        //批量删除
        $(".btn-batchDelete").on("click",function () {
            var selections = $("#table1").bootstrapTable('getSelections');
            if(selections.length == 0){
                layer.msg("请选择一条数据进行操作");
                return;
            }else{
                var arry=[];
                $.each(selections,function (index,row) {
                    arry.push(row.userId);
                });
                layer.confirm('是否确定删除?', {
                    title: '提示',
                    btn: ['确定', '取消'] //按钮
                }, function (index) {
                    $.ajax({
                        url:'/sys/user/batchDelete.shtm',
                        type:'POST',
                        dataType:"json",
                        data:JSON.stringify({ids:arry.join(",")}),
                        contentType: "application/json; charset=utf-8",
                        success:function (result) {
                            layer.msg(result.msg);
                            $("#table1").bootstrapTable('refresh');
                        }
                    });
                }, function (index) {
                    layer.close(index);
                });
            }
        });
        //重置密码
        $(".btn-reset").on("click",function () {
            var selections = $("#table1").bootstrapTable('getSelections');
            if(selections.length == 0 || selections.length > 1){
                layer.msg("请选择一条数据进行操作");
                return;
            }else{
                var userId = selections[0].userId;
                layer.confirm('是否确定重置密码?', {
                    title: '提示',
                    btn: ['确定', '取消'] //按钮
                }, function (index) {
                    $.ajax({
                        url:'/sys/user/password/reset.shtm',
                        type:'post',
                        dataType:"json",
                        data:{userId:userId},
                        success:function (result) {
                            layer.msg(result.msg);
                            $("#table1").bootstrapTable('refresh');
                        }
                    });
                }, function (index) {
                    layer.close(index);
                });
            }
        });
        //切换角色
        $("#role").change(function(){
            var cls = $(this).find("option:selected").attr("cls");
            $(".mould-item").hide(); $(".btn-item").hide();$("."+cls).show();
            if(cls=="sysUser"){
                loadPTUserList();
            }else{
                loadRegisterUserList();
            }
        });
    });
    /**
     * 加载平台用户
     */
    function loadPTUserList(){
        $(".bootstrap-table").hide();
        if(table1==null){
            table1 = $('#table1').bootstrapTable({
                method: "post",
                striped: false,
                singleSelect: false,
                url: "/sys/user/list.shtm",
                dataType: "json",
                pagination: true, //分页
                pageSize: 10,
                pageNumber: 1,
                search: false, //显示搜索框
                contentType: "application/x-www-form-urlencoded",
                sidePagination: "server", //服务端请求
                clickToSelect : true, //是否启用点击选中行
                queryParams:function(params) {
                    return {
                        pageNum: params.offset/params.limit+1,
                        pageSize: params.limit,//页码大小
                        userName:$("#UserName").val(),
                        loginName:$("#LoginName").val(),
                        tel:$("#Tel").val()
                    };
                },
                //返回数据格式处理
                responseHandler: function(res) {
                    return {
                        "total": res.data.total,//总页数
                        "rows": res.data.list   //数据
                    };
                },
                onDblClickRow: function (row) {},
                columns: [
                    {
                        checkbox: "true",
                        field: 'check',
                        align: 'center'
                    },
                    {
                        title: "用户名称",
                        field: 'userName',
                        align: 'center'
                    },
                    {
                        title: "登录名",
                        field: 'loginName',
                        align: 'center'
                    },
                    {
                        title: '角色',
                        field: 'role.roleName',
                        align: 'center'
                    },
                    {
                        title: "电话号码",
                        field: 'tel',
                        align: 'center'
                    },
                    {
                        title: '证件号码',
                        field: 'idnumber',
                        align: 'center'
                    },
                    {
                        title: '邮箱地址',
                        field: 'email',
                        align: 'center'
                    }
                ]
            });
        }else{
            $(".bootstrap-table:first").show();
            $("#table1").bootstrapTable('refresh');
        }
    }

    /**
     * 加载注册用户
     */
    function loadRegisterUserList(){
        $(".bootstrap-table").hide();
        if(table2==null){
            table2 = $('#table2').bootstrapTable({
                method: "post",
                striped: false,
                singleSelect: false,
                url: "/account/list.shtm",
                dataType: "json",
                pagination: true, //分页
                pageSize: 10,
                pageNumber: 1,
                search: false, //显示搜索框
                contentType: "application/x-www-form-urlencoded",
                sidePagination: "server", //服务端请求
                queryParams:function(params) {
                    return {
                        pageNum: params.offset/params.limit+1,
                        pageSize: params.limit,//页码大小
                        userName:$("#UserName2").val(),
                        emailAddress:$("#EmailAddress").val()
                    };
                },
                //返回数据格式处理
                responseHandler: function(res) {
                    return {
                        "total": res.data.total,//总页数
                        "rows": res.data.list   //数据
                    };
                },
                singleSelect : true,
                onDblClickRow: function (row) {
                },
                columns: [
                    {
                        title: "序号",
                        field: 'accountCode',
                        align: 'center'
                    },
                    {
                        title: "用户名称",
                        field: 'userName',
                        align: 'center'
                    },
                    {
                        title: "邮箱地址",
                        field: 'emailAddress',
                        align: 'center'
                    },
                    {
                        title: '收货地址',
                        field: 'buyingShipping',
                        align: 'center'
                    },
                    {
                        title: "采用的货币",
                        field: 'selectedCurrency',
                        align: 'center'
                    }
                ]
            });
        }else{
            $(".bootstrap-table:last").show();
            $("#table2").bootstrapTable('refresh');
        }
    }
</script>
</html>